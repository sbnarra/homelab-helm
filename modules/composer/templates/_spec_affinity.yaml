{{- define "spec.affinity" }}
{{- $requiredAffinity := or .Values.affinity.required.default .Values.affinity.required.labels }}
{{- $preferredAffinity := or .Values.affinity.preferred.default .Values.affinity.preferred.labels }}
{{- if or $requiredAffinity $preferredAffinity }}
affinity:
  nodeAffinity:
{{- end }}
    {{- if $requiredAffinity }}
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
      - matchExpressions:
    {{- end }}
    {{- if .Values.affinity.required.default }}
        - key: affinity/{{ .Release.Namespace }}
          operator: Exists
    {{- end }}
    {{- range $k, $v := .Values.affinity.required.labels }}
        - key: {{ $k }}
          operator: {{ $v.operator | default "In" }}
          {{- if $v.values }}
          values: {{ $v.values }}
          {{- end }}
    {{- end }}
    {{- if $preferredAffinity }}
    preferredDuringSchedulingIgnoredDuringExecution:
    {{- end }}
    {{- range $k, $v := .Values.affinity.preferred.labels }}
    - weight: {{ $v.weight }}
      preference:
        matchExpressions:
        - key: {{ $k }}
          operator: {{ $v.operator | default "In" }}
          {{- if $v.values }}
          values: {{ $v.values }}
          {{- end }}
    {{- end }}
    {{- if .Values.affinity.preferred.default }}
    - weight: 40
      preference:
        matchExpressions:
        - key: affinity/{{ .Release.Namespace }}.{{ .Release.Name }}
          operator: Exists
    {{- end }}
{{- end }}