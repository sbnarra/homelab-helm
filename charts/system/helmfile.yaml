bases:
- ../../config/environments.yaml.gotmpl
- ../../modules/templates.yaml.gotmpl
---
repositories:
- name: keel
  url: https://charts.keel.sh
- name: prometheus-community
  url: https://prometheus-community.github.io/helm-charts
- name: grafana
  url: https://grafana.github.io/helm-charts
---
releases:
- inherit:
  - template: deployment-storage

- name: backup
  inherit:
  - template: stateless-deployment

- name: startpage
  inherit:
  - template: stateless-deployment

- name: keel
  inherit:
  - template: stateless-deployment
  values: [keel/values.yaml.gotmpl]

# this storage is required as prometheus creates it own pvc
- name: prometheus-storage
  inherit:
  - template: storage
  values:
  - unclaimed: true
    nfs:
      path: "{{ .Values.persistencePath }}/{{ .Release.Namespace }}/prometheus"

- name: prometheus
  inherit:
  - template: stateful-deployment
  values: [prometheus/values.yaml.gotmpl]
  needs: [prometheus-storage]

- name: loki
  inherit:
  - template: stateful-deployment
  values: [loki/values.yaml.gotmpl]
  needs: [prometheus]